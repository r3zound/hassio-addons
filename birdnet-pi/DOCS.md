# éº¦å…‹é£è€ƒè™‘äº‹é¡¹
å…³é”®è¦ç´ æ˜¯éº¦å…‹é£çš„è´¨é‡ï¼šBoya By-lm 40 æˆ– clippy EM272ï¼ˆé…æœ‰éå¸¸å¥½çš„ aux-usb è½¬æ¢å™¨ï¼‰å¯¹æé«˜æ£€æµ‹è´¨é‡è‡³å…³é‡è¦ã€‚ 
ä»¥ä¸‹æ˜¯æˆ‘è¿›è¡Œçš„ä¸€äº›ç¤ºä¾‹æµ‹è¯•ï¼ˆæ•´ä¸ªçº¿ç¨‹çœŸçš„å¾ˆæœ‰è¶£ï¼‰ï¼š https://github.com/mcguirepr89/BirdNET-Pi/discussions/39#discussioncomment-9706951 
https://github.com/mcguirepr89/BirdNET-Pi/discussions/1092#discussioncomment-9706191

æˆ‘çš„æ¨èï¼š
- æœ€ä½³å…¥é—¨ç³»ç»Ÿï¼ˆ< 50â‚¬ï¼‰ï¼šBoya By-lm40ï¼ˆ30â‚¬ï¼‰+ deadcatï¼ˆ10â‚¬ï¼‰
- æœ€ä½³ä¸­ç«¯ç³»ç»Ÿï¼ˆ< 150 â‚¬ï¼‰ï¼šClippy EM272 TRS/TRRSï¼ˆ55â‚¬ï¼‰+ Rode AI micro trs/trrs è½¬ usbï¼ˆ70â‚¬ï¼‰+ Rycote deadcatï¼ˆ27â‚¬ï¼‰
- æœ€ä½³é«˜ç«¯ç³»ç»Ÿï¼ˆ<400 â‚¬ï¼‰ï¼šClippy EM272 XLRï¼ˆ85â‚¬ï¼‰æˆ– LOM Ucho Proï¼ˆ75â‚¬ï¼‰+ Focusrite Scarlet 2i2 ç¬¬å››ä»£ï¼ˆ200â‚¬ï¼‰+ Bubblebee Pro Extreme deadcatï¼ˆ45â‚¬ï¼‰

æ¬§æ´²é«˜ç«¯éº¦å…‹é£çš„æ¥æºï¼š
- Clippyï¼ˆEM272ï¼‰ï¼šhttps://www.veldshop.nl/en/clippy-xlr-em272z1-mono-microphone.html
- LOMï¼ˆEM272ï¼‰ï¼šhttps://store.lom.audio/collections/basicucho-series
- Immersive soundï¼ˆAOM5024ï¼‰ï¼šhttps://immersivesoundscapes.com/earsight-standard-v2/

# åº”ç”¨è®¾ç½®å»ºè®®
æˆ‘é€šè¿‡å¹¶è¡Œè¿è¡Œæˆ‘çš„ HA birdnet-pi é™„åŠ ç»„ä»¶çš„ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä½¿ç”¨ç›¸åŒçš„ rtsp æºï¼Œæµ‹è¯•äº†è®¸å¤šè®¾ç½®ï¼Œå¹¶æ¯”è¾ƒå‚æ•°çš„å½±å“ã€‚ 
æˆ‘çš„ç»“è®ºå¹¶ä¸æ™®éï¼Œå› ä¸ºå®ƒä¼¼ä¹é«˜åº¦ä¾èµ–äºæ‰€ç”¨çš„åœ°åŒºå’Œéº¦å…‹é£ç±»å‹ã€‚ä¾‹å¦‚ï¼Œæ—§å‹å·åœ¨æ¾³å¤§åˆ©äºšä¼¼ä¹è¡¨ç°æ›´å¥½ï¼Œè€Œæ–°å‹å·åœ¨æ¬§æ´²è¡¨ç°æ›´å¥½ã€‚

- æ¨¡å‹
    - ç‰ˆæœ¬ï¼š6k_v2,4 _(åœ¨æ¬§æ´²è‡³å°‘è¡¨ç°æ›´å¥½ï¼Œ6k åœ¨æ¾³å¤§åˆ©äºšè¡¨ç°æ›´å¥½)_
    - ç‰©ç§èŒƒå›´æ¨¡å‹ï¼šv1 _(å–æ¶ˆå‹¾é€‰ v2.4ï¼›åœ¨æ¬§æ´²ä¼¼ä¹æ›´ç¨³å¥)_
    - ç‰©ç§å‡ºç°é˜ˆå€¼ï¼š0.001 _(åœ¨ä½¿ç”¨ v2.4 æ—¶ä¸º 0.00015ï¼›ä½¿ç”¨ç‰©ç§åˆ—è¡¨æµ‹è¯•å™¨æ£€æŸ¥é€‚åˆæ‚¨çš„æ­£ç¡®å€¼)_
- éŸ³é¢‘è®¾ç½®
    - é»˜è®¤
    - é€šé“ï¼š1 _(å¹¶ä¸æ˜¯ç‰¹åˆ«é‡è¦ï¼Œå› ä¸ºåˆ†ææ˜¯åŸºäºå•å£°é“ä¿¡å·ï¼›1 å…è®¸å‡å°ä¿å­˜éŸ³é¢‘çš„å¤§å°ï¼Œä½†åœ¨æˆ‘çš„ç»éªŒä¸­ä¼¼ä¹ä¼šå¯¼è‡´å…‰è°±å›¾è½»å¾®æ··ä¹±)_
    - å½•éŸ³é•¿åº¦ï¼š18 _(è¿™å› ä¸ºæˆ‘ä½¿ç”¨äº† 0.5 çš„é‡å ï¼›æ‰€ä»¥å®ƒåˆ†æ 0-3sï¼›2.5-5.5sï¼›5-8sï¼›7.5-10.5ï¼›10-13ï¼›12.5-15.5ï¼›15-18)_
    - æå–é•¿åº¦ï¼š9s _(å¯ä»¥æ˜¯ 6ï¼Œä½†æˆ‘å–œæ¬¢å¬é¸Ÿ :-))_
    - éŸ³é¢‘æ ¼å¼ï¼šmp3 _(ä¸ºä»€ä¹ˆè¦éº»çƒ¦ä½¿ç”¨å…¶ä»–æ ¼å¼)_
- Birdnet-lite è®¾ç½®
    - é‡å ï¼š0.5s
    - æœ€å°ç½®ä¿¡åº¦ï¼š0.7
    - Sigmoid çµæ•åº¦ï¼š1.25 _(æˆ‘å°è¯•è¿‡ 1.00ï¼Œä½†å®ƒäº§ç”Ÿäº†æ›´å¤šçš„è¯¯æŠ¥ï¼›å› ä¸ºé™ä½è¿™ä¸ªå€¼ä¼šå¢åŠ çµæ•åº¦)_

# è®¾ç½® RTSP æœåŠ¡å™¨

çµæ„Ÿæ¥è‡ªï¼šhttps://github.com/mcguirepr89/BirdNET-Pi/discussions/1006#discussioncomment-6747450

<details>
<summary>åœ¨æ‚¨çš„æ¡Œé¢ä¸Š</summary>
   
- ä¸‹è½½æ˜ åƒå·¥å…·
- å®‰è£… Raspbian Lite 64
</details>

<details>
<summary>é€šè¿‡ SSH å®‰è£…æ‰€éœ€è½¯ä»¶</summary>

### 
```
# æ›´æ–°

sudo apt-get update -y
sudo apt-get dist-upgrade -y

# å®‰è£… RTSP æœåŠ¡å™¨
sudo apt-get install -y micro ffmpeg lsof
sudo -s cd /root && wget -c https://github.com/bluenviron/mediamtx/releases/download/v1.9.1/mediamtx_v1.9.1_linux_arm64v8.tar.gz -O - | sudo tar -xz
```

</details>


<details>
<summary>é…ç½®éŸ³é¢‘</summary>

### æ‰¾åˆ°æ­£ç¡®çš„è®¾å¤‡
```
# åˆ—å‡ºéŸ³é¢‘è®¾å¤‡
arecord -l

# æ£€æŸ¥éŸ³é¢‘è®¾å¤‡å‚æ•°ã€‚ç¤ºä¾‹ï¼š
arecord -D hw:1,0 --dump-hw-params
```

### æ·»åŠ å¯åŠ¨è„šæœ¬
sudo nano startmic.sh && chmod +x startmic.sh
```
#!/bin/bash
echo "å¯åŠ¨ birdmic"

# ç¦ç”¨åƒå…†ä»¥å¤ªç½‘
sudo ethtool -s eth0 speed 100 duplex full autoneg on

# æ£€æµ‹ Scarlett 2i2 å¡çš„ç´¢å¼• - ä»…åœ¨ä½¿ç”¨è¯¥å¡æ—¶ç›¸å…³
SCARLETT_INDEX=$(arecord -l | grep -i "Scarlett" | awk '{print $2}' | sed 's/://')

if [ -z "$SCARLETT_INDEX" ]; then
    echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° Scarlett 2i2ï¼ä½¿ç”¨ 0 ä½œä¸ºé»˜è®¤å€¼"
    SCARLETT_INDEX="0"
fi

# é¦–å…ˆå¯åŠ¨ mediamtx å¹¶ç»™å®ƒä¸€ç‚¹æ—¶é—´è¿›è¡Œåˆå§‹åŒ–
./mediamtx & 
sleep 5
    
# è¿è¡Œ ffmpeg
ffmpeg -nostdin -use_wallclock_as_timestamps 1 -fflags +genpts -f alsa -acodec pcm_s16be -ac 2 -ar 96000 \
-i plughw:$SCARLETT_INDEX,0 -ac 2 -f rtsp -acodec pcm_s16be rtsp://localhost:8554/birdmic -rtsp_transport tcp \
-buffer_size 512k 2>/tmp/rtsp_error &

# è®¾ç½®éº¦å…‹é£éŸ³é‡
sleep 5
MICROPHONE_NAME="Line In 1 Gain" # å¯¹äº Focusrite Scarlett 2i2
sudo amixer -c 0 sset "$MICROPHONE_NAME" 40

sleep 60

# è¿è¡Œ focusrite å’Œ autogain è„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
if [ -f "$HOME/focusrite.sh" ]; then
    sudo python3 -u "$HOME/focusrite.sh" >/tmp/log_focusrite 2>/tmp/log_focusrite_error &
fi

if [ -f "$HOME/autogain.py" ]; then
    sudo python3 -u "$HOME/autogain.py" >/tmp/log_autogain 2>/tmp/log_autogain_error &
fi
```

</details>

<details>
<summary>å¯é€‰ï¼šä½¿ç”¨ gstreamer è€Œä¸æ˜¯ ffmpeg</summary>

```
# å®‰è£… gstreamer
sudo apt-get update
#sudo apt-get install -y \
#  gstreamer1.0-rtsp \
#  gstreamer1.0-tools \
#  gstreamer1.0-alsa \
#  gstreamer1.0-plugins-base \
#  gstreamer1.0-plugins-good \
#  gstreamer1.0-plugins-bad \
#  gstreamer1.0-plugins-ugly \
#  gstreamer1.0-libav
apt-get install libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libgstreamer-plugins-bad1.0-dev gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-libav gstreamer1.0-tools gstreamer1.0-x gstreamer1.0-alsa gstreamer1.0-gl gstreamer1.0-gtk3 gstreamer1.0-qt5 gstreamer1.0-pulseaudio -y
```

åˆ›å»ºåä¸º rtsp_audio_server.py çš„è„šæœ¬
```
#!/usr/bin/env python3

import gi
import sys
import logging
import os
import signal

gi.require_version('Gst', '1.0')
gi.require_version('GstRtspServer', '1.0')

from gi.repository import Gst, GstRtspServer, GLib

# åˆå§‹åŒ– GStreamer
Gst.init(None)

# é…ç½®æ—¥å¿—è®°å½•
LOG_FILE = "gst_rtsp_server.log"
logging.basicConfig(
    filename=LOG_FILE,
    filemode='a',
    format='%(asctime)s %(levelname)s: %(message)s',
    level=logging.DEBUG  # è®¾ç½®ä¸º DEBUG ä»¥è·å–å…¨é¢çš„æ—¥å¿—è®°å½•
)
logger = logging.getLogger(__name__)

class AudioFactory(GstRtspServer.RTSPMediaFactory):
    def __init__(self):
        super(AudioFactory, self).__init__()
        self.set_shared(True)          # å…è®¸å¤šä¸ªå®¢æˆ·ç«¯è®¿é—®æµ
        self.set_latency(500)          # å¢åŠ å»¶è¿Ÿåˆ° 500 æ¯«ç§’ä»¥æ”¹å–„æµçš„ç¨³å®šæ€§
        self.set_suspend_mode(GstRtspServer.RTSPSuspendMode.NONE)  # é˜²æ­¢æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥æ—¶æµçš„æš‚åœ
        logger.debug("AudioFactory åˆå§‹åŒ–ï¼šshared=True, latency=500ms, suspend_mode=NONE.")

    def do_create_element(self, url):
        """
        åˆ›å»ºå¹¶è¿”å›ç”¨äºæµå¼ä¼ è¾“éŸ³é¢‘çš„ GStreamer æµæ°´çº¿ã€‚
        """
        pipeline_str = (
            "alsasrc device=plughw:0,0 do-timestamp=true buffer-time=2000000 latency-time=1000000 ! "  # å¢åŠ ç¼“å†²åŒºå¤§å°
            "queue max-size-buffers=0 max-size-bytes=0 max-size-time=0 ! "         # æ·»åŠ é˜Ÿåˆ—ä»¥å¤„ç†ç¼“å†²åŒºç®¡ç†
            "audioconvert ! "                                # å°†éŸ³é¢‘è½¬æ¢ä¸ºé€‚åˆçš„æ ¼å¼
            "audioresample ! "                               # å¦‚æœå¿…è¦ï¼Œé‡æ–°é‡‡æ ·éŸ³é¢‘
            "audio/x-raw,format=S16BE,channels=2,rate=48000 ! "  # è®¾ç½®éŸ³é¢‘å±æ€§ï¼ˆé€Ÿç‡ = 48kHzï¼‰
            "rtpL16pay name=pay0 pt=96"                     # RTP çš„æœ‰æ•ˆè½½è·
        )
        logger.debug(f"åˆ›å»º GStreamer æµæ°´çº¿ï¼š{pipeline_str}")
        try:
            pipeline = Gst.parse_launch(pipeline_str)
            if not pipeline:
                logger.error("è§£æ GStreamer æµæ°´çº¿å¤±è´¥ã€‚")
                return None
            return pipeline
        except Exception as e:
            logger.error(f"åˆ›å»ºæµæ°´çº¿æ—¶å‘ç”Ÿå¼‚å¸¸ï¼š{e}")
            return None

class GstServer:
    def __init__(self):
        self.server = GstRtspServer.RTSPServer()
        self.server.set_service("8554")      # è®¾ç½® RTSP æœåŠ¡å™¨ç«¯å£
        self.server.set_address("0.0.0.0")   # ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£
        logger.debug("RTSP æœåŠ¡å™¨é…ç½®ï¼šaddress=0.0.0.0, port=8554.")

        factory = AudioFactory()
        mount_points = self.server.get_mount_points()
        mount_points.add_factory("/birdmic", factory)  # æŒ‚è½½ç‚¹
        logger.debug("å·¥å‚æŒ‚è½½åœ¨ /birdmic.")

        self.server.attach(None)  # å°†æœåŠ¡å™¨é™„åŠ åˆ°é»˜è®¤ä¸»è¦ä¸Šä¸‹æ–‡
        logger.info("RTSP æœåŠ¡å™¨å·²é™„åŠ å¹¶æ­£åœ¨è¿è¡Œã€‚")

def main():
    # åˆ›å»º GstServer å®ä¾‹
    server = GstServer()
    print("RTSP æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œåœ°å€ä¸º rtsp://localhost:8554/birdmic")
    logger.info("RTSP æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œåœ°å€ä¸º rtsp://localhost:8554/birdmic")

    # è®¾ç½®ä¸»å¾ªç¯å¹¶è¿›è¡Œé€‚å½“çš„æ—¥å¿—è®°å½•
    loop = GLib.MainLoop()

    # å¤„ç†ç»ˆæ­¢ä¿¡å·ä»¥ç¡®ä¿ä¼˜é›…å…³é—­
    def shutdown(signum, frame):
        logger.info(f"ç”±äºä¿¡å· {signum} æ­£åœ¨å…³é—­ RTSP æœåŠ¡å™¨ã€‚")
        print("\næ­£åœ¨å…³é—­ RTSP æœåŠ¡å™¨ã€‚")
        loop.quit()

    # æ³¨å†Œä¿¡å·å¤„ç†ç¨‹åºä»¥å®ç°ä¼˜é›…ç»ˆæ­¢
    signal.signal(signal.SIGINT, shutdown)
    signal.signal(signal.SIGTERM, shutdown)

    try:
        loop.run()
    except Exception as e:
        logger.error(f"ä¸»å¾ªç¯é‡åˆ°å¼‚å¸¸ï¼š{e}")
    finally:
        logger.info("RTSP æœåŠ¡å™¨å·²å…³é—­ã€‚")

if __name__ == "__main__":
    # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨
    if not os.path.exists(LOG_FILE):
        open(LOG_FILE, 'w').close()

    main()
```

</details>

<details>
<summary>å¯é€‰ï¼šè‡ªåŠ¨å¯åŠ¨</summary>

```
chmod +x startmic.sh
crontab -e # é€‰æ‹© nano ä½œä¸ºæ‚¨çš„ç¼–è¾‘å™¨
```
åœ¨ `@reboot $HOME/startmic.sh` ä¸­ç²˜è´´ï¼Œç„¶åä¿å­˜å¹¶é€€å‡º nanoã€‚
é‡å¯ Piï¼Œå¹¶ä½¿ç”¨ VLC æµ‹è¯•ä»¥ç¡®ä¿ RTSP æµæ˜¯å®æ—¶çš„ã€‚

</details>

<details>
<summary>å¯é€‰ï¼šç¦ç”¨ä¸å¿…è¦çš„å…ƒç´ </summary>

- ä¼˜åŒ– config.txt

sudo nano /boot/firmware/config.txt
```
# å¯ç”¨éŸ³é¢‘å’Œ USB ä¼˜åŒ–
dtparam=audio=off          # ç¦ç”¨é»˜è®¤çš„æ¿è½½éŸ³é¢‘ä»¥é˜²æ­¢å†²çª
dtoverlay=disable-bt        # ç¦ç”¨æ¿è½½è“ç‰™ä»¥å‡å°‘ USB å¸¦å®½ä½¿ç”¨
dtoverlay=disable-wifi      # ç¦ç”¨æ¿è½½ WiFi
# å°†ä»¥å¤ªç½‘é™åˆ¶ä¸º 100 Mbpsï¼ˆç¦ç”¨åƒå…†ä»¥å¤ªç½‘ï¼‰
dtparam=eth_max_speed=100
# USB ä¼˜åŒ–
dwc_otg.fiq_fix_enable=1    # å¯ç”¨ FIQï¼ˆå¿«é€Ÿä¸­æ–­ï¼‰å¤„ç†ä»¥æ”¹å–„ USB æ€§èƒ½
max_usb_current=1           # å¢åŠ å¯ç”¨ USB ç”µæµï¼ˆå¦‚æœ Scarlett é€šè¿‡ USB ä¾›ç”µåˆ™éœ€è¦ï¼‰
# é™„åŠ éŸ³é¢‘è®¾ç½®ï¼ˆç”¨äºä½å»¶è¿Ÿæ“ä½œï¼‰
avoid_pwm_pll=1             # ä½¿ç”¨æ›´ç¨³å®šçš„ PLL ä½œä¸ºéŸ³é¢‘æ—¶é’Ÿ
# å¯é€‰ï¼šå¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥å…³é—­ HDMI å’Œå…¶ä»–è®¾ç½®
hdmi_blanking=1             # ç¦ç”¨ HDMIï¼ˆèŠ‚çœç”µæºå¹¶å‡å°‘å¹²æ‰°ï¼‰
```

- ç¦ç”¨æ— ç”¨æœåŠ¡

```

# ç¦ç”¨æ— ç”¨æœåŠ¡
sudo systemctl disable hciuart
sudo systemctl disable bluetooth
sudo systemctl disable triggerhappy
sudo systemctl disable avahi-daemon
sudo systemctl disable dphys-swapfile
sudo systemctl disable hciuart.service

# ç¦ç”¨è“ç‰™
for element in bluetooth btbcm hci_uart btintel btrtl btusb; do
    sudo sed -i "/$element/d" /etc/modprobe.d/raspi-blacklist.conf
    echo "blacklist $element" | sudo tee -a /etc/modprobe.d/raspi-blacklist.conf
done

# åœ¨ Raspberry Pi ä¸Šç¦ç”¨è§†é¢‘ï¼ˆåŒ…æ‹¬ V4L2ï¼‰
for element in bcm2835_v4l2 bcm2835_codec bcm2835_isp videobuf2_vmalloc videobuf2_memops videobuf2_v4l2 videobuf2_common videodev; do
    sudo sed -i "/$element/d" /etc/modprobe.d/raspi-blacklist.conf
    echo "blacklist $element" | sudo tee -a /etc/modprobe.d/raspi-blacklist.conf
done

# ç¦ç”¨ WiFi ç”µæºç®¡ç†
sudo iw dev wlan0 set power_save off
for element in brcmfmac brcmutil; do
    sudo sed -i "/$element/d" /etc/modprobe.d/raspi-blacklist.conf
    echo "blacklist $element" | sudo tee -a /etc/modprobe.d/raspi-blacklist.conf
done

# ç¦ç”¨ USB ç”µæºç®¡ç†
echo 'on' | sudo tee /sys/bus/usb/devices/usb*/power/control

# é˜²æ­¢ Raspberry Pi è¿›å…¥çœç”µæ¨¡å¼
sudo apt update
sudo apt install -y cpufrequtils
echo 'GOVERNOR="performance"' | sudo tee /etc/default/cpufrequtils
sudo systemctl disable ondemand
sudo systemctl stop ondemand

```

</details>

<details>
<summary>å¯é€‰ï¼šå®‰è£… Focusrite é©±åŠ¨ç¨‹åº</summary>
    
```
sudo apt-get install make linux-headers-$(uname -r)
curl -LO https://github.com/geoffreybennett/scarlett-gen2/releases/download/v6.9-v1.3/snd-usb-audio-kmod-6.6-v1.3.tar.gz
tar -xzf snd-usb-audio-kmod-6.6-v1.3.tar.gz
cd snd-usb-audio-kmod-6.6-v1.3
KSRCDIR=/lib/modules/$(uname -r)/build
make -j4 -C $KSRCDIR M=$(pwd) clean
make -j4 -C $KSRCDIR M=$(pwd)
sudo make -j4 -C $KSRCDIR M=$(pwd) INSTALL_MOD_DIR=updates/snd-usb-audio modules_install
sudo depmod
sudo reboot
dmesg | grep -A 5 -B 5 -i focusrite
```

</details>

<details>
<summary>å¯é€‰ï¼šæ·»åŠ  RAM ç£ç›˜</summary>
    
```
sudo cp /usr/share/systemd/tmp.mount /etc/systemd/system/tmp.mount
sudo systemctl enable tmp.mount
sudo systemctl start tmp.mount
```

</details>

<details>
<summary>å¯é€‰ï¼šFocusrite Scarlett 2i2 çš„é…ç½®</summary>

å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ° "$HOME/focusrite.sh" && chmod +x "$HOME/focusrite.sh"
```
#!/bin/bash

# è®¾ç½® PCM æ§ä»¶ä»¥è¿›è¡Œæ•è·
sudo amixer -c 0 cset numid=31 'Analogue 1'  # 'PCM 01' - è®¾ç½®ä¸º 'Analogue 1'
sudo amixer -c 0 cset numid=32 'Analogue 1'  # 'PCM 02' - è®¾ç½®ä¸º 'Analogue 1'
sudo amixer -c 0 cset numid=33 'Off'         # 'PCM 03' - ç¦ç”¨
sudo amixer -c 0 cset numid=34 'Off'         # 'PCM 04' - ç¦ç”¨

# è®¾ç½® DSP è¾“å…¥æ§ä»¶ï¼ˆæœªä½¿ç”¨ï¼Œè®¾ç½®ä¸ºå…³é—­ï¼‰
sudo amixer -c 0 cset numid=29 'Off'         # 'DSP Input 1'
sudo amixer -c 0 cset numid=30 'Off'         # 'DSP Input 2'

# å°† Line In 1 é…ç½®ä¸ºå•å£°é“è®¾ç½®çš„ä¸»è¦è¾“å…¥
sudo amixer -c 0 cset numid=8 'Off'          # 'Line In 1 Air' - ä¿æŒä¸º 'Off'
sudo amixer -c 0 cset numid=14 off           # 'Line In 1 Autogain' - ç¦ç”¨
sudo amixer -c 0 cset numid=6 'Line'         # 'Line In 1 Level' - è®¾ç½®çº§åˆ«ä¸º 'Line'
sudo amixer -c 0 cset numid=21 on           # 'Line In 1 Safe' - å¯ç”¨ä»¥é¿å…å‰Šæ³¢/å™ªéŸ³å½±å“ï¼Ÿ

# ç¦ç”¨ Line In 2 ä»¥æœ€å°åŒ–å¹²æ‰°ï¼ˆå¦‚æœæœªä½¿ç”¨ï¼‰
sudo amixer -c 0 cset numid=9 'Off'          # 'Line In 2 Air'
sudo amixer -c 0 cset numid=17 off           # 'Line In 2 Autogain' - ç¦ç”¨
sudo amixer -c 0 cset numid=16 0             # 'Line In 2 Gain' - è®¾ç½®å¢ç›Šä¸º 0ï¼ˆé™éŸ³ï¼‰
sudo amixer -c 0 cset numid=7 'Line'         # 'Line In 2 Level' - è®¾ç½®ä¸º 'Line'
sudo amixer -c 0 cset numid=22 off           # 'Line In 2 Safe' - ç¦ç”¨

# è®¾ç½® Line In 1-2 æ§ä»¶
sudo amixer -c 0 cset numid=12 off           # 'Line In 1-2 Link' - å•å£°é“ä¸éœ€è¦è¿æ¥
sudo amixer -c 0 cset numid=10 on            # 'Line In 1-2 Phantom Power' - å¯ç”¨ä»¥ä¾›å†·å‡éº¦å…‹é£ä½¿ç”¨

# å°†æ¨¡æ‹Ÿè¾“å‡ºè®¾ç½®ä¸ºä½¿ç”¨ç›¸åŒçš„æ··éŸ³ä½œä¸ºä¸¤ä¸ªé€šé“ï¼ˆå•å£°é“è®¾ç½®ï¼‰
sudo amixer -c 0 cset numid=23 'Mix A'       # 'Analogue Output 01' - è®¾ç½®ä¸º 'Mix A'
sudo amixer -c 0 cset numid=24 'Mix A'       # 'Analogue Output 02' - ä¸è¾“å‡º 01 ç›¸åŒ

# å°†ç›´æ¥ç›‘æ§å…³é—­ä»¥é˜²æ­¢å›å£°
sudo amixer -c 0 cset numid=53 'Off'         # 'Direct Monitor'

# å°†è¾“å…¥é€‰æ‹©è®¾ç½®ä¸ºè¾“å…¥ 1
sudo amixer -c 0 cset numid=11 'Input 1'     # 'Input Select'

# ä¼˜åŒ–ç›‘æ§æ··éŸ³è®¾ç½®ä»¥ç”¨äºå•å£°é“è¾“å‡º
sudo amixer -c 0 cset numid=54 153           # 'Monitor 1 Mix A Input 01' - è®¾ç½®ä¸º 153ï¼ˆçº¦ -3.50 dBï¼‰
sudo amixer -c 0 cset numid=55 153           # 'Monitor 1 Mix A Input 02' - è®¾ç½®ä¸º 153ï¼Œä»¥å®ç°å¹³è¡¡è¾“å‡º
sudo amixer -c 0 cset numid=56 0             # 'Monitor 1 Mix A Input 03' - é™éŸ³æœªä½¿ç”¨çš„é€šé“
sudo amixer -c 0 cset numid=57 0             # 'Monitor 1 Mix A Input 04'

# å°†åŒæ­¥çŠ¶æ€è®¾ç½®ä¸ºé”å®š
sudo amixer -c 0 cset numid=52 'Locked'      # 'Sync Status'

echo "å•å£°é“ä¼˜åŒ–å·²åº”ç”¨ã€‚ä»…ä½¿ç”¨ä¸»è¾“å…¥å’Œå¹³è¡¡è¾“å‡ºã€‚"
```
</details>

<details>
<summary>å¯é€‰ï¼šéº¦å…‹é£çš„è‡ªåŠ¨å¢ç›Šè„šæœ¬</summary>

å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ° "$HOME/autogain.py" && chmod +x "$HOME/autogain.py"

```python
#!/usr/bin/env python3
"""
åŠ¨æ€éº¦å…‹é£å¢ç›Šè°ƒæ•´è„šæœ¬ï¼Œå…·æœ‰äº¤äº’å¼æ ¡å‡†ã€
è‡ªæˆ‘ä¿®æ”¹ï¼Œä»¥åŠå®æ—¶ RMS å›¾çš„æµ‹è¯•æ¨¡å¼ï¼Œä½¿ç”¨ plotext

ç”¨æ³•ï¼š
  æ­£å¸¸æ“ä½œï¼ˆå¢ç›Šæ§åˆ¶å¾ªç¯ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼‰ï¼š
      ./autogain.py
  äº¤äº’æ ¡å‡†ï¼ˆæç¤ºè¾“å…¥éº¦å…‹é£è§„æ ¼ï¼Œç„¶åè¯¢é—®æ˜¯å¦ä¿å­˜å€¼ï¼‰ï¼š
      ./autogain.py --calibrate
  æµ‹è¯•æ¨¡å¼ï¼ˆå¸¦æœ‰è‰²å½©ç¼–ç çš„å®æ—¶ RMS æ¼”å˜å›¾ï¼‰ï¼š
      ./autogain.py --test

ä½œè€…ï¼šæ‚¨çš„åå­—
æ—¥æœŸï¼š2025-04-08
"""

import argparse
import subprocess
import numpy as np
from scipy.signal import butter, sosfilt
import time
import re
import sys
import os

# ---------------------- é»˜è®¤é…ç½® ----------------------

MICROPHONE_NAME = "Line In 1 Gain"
MIN_GAIN_DB = 20
MAX_GAIN_DB = 40
GAIN_STEP_DB = 3

# é»˜è®¤ RMS é˜ˆå€¼ï¼ˆåœ¨æ­£å¸¸æ“ä½œä¸­ä½¿ç”¨ï¼‰
NOISE_THRESHOLD_HIGH = 0.0012589
NOISE_THRESHOLD_LOW  = 0.00035

SAMPLING_RATE = 48000  # 48 kHz
LOWCUT        = 2000
HIGHCUT       = 8000
FILTER_ORDER  = 4
RTSP_URL      = "rtsp://192.168.178.124:8554/birdmic"
SLEEP_SECONDS = 10

REFERENCE_PRESSURE = 20e-6  # 20 ÂµPa

# é»˜è®¤éº¦å…‹é£è§„æ ¼ï¼ˆç”¨äºæ ¡å‡†å‚è€ƒï¼‰
DEFAULT_SNR         = 80.0    # dB
DEFAULT_SELF_NOISE  = 14.0    # dB-A
DEFAULT_CLIPPING    = 120.0   # dB SPL
DEFAULT_SENSITIVITY = -28.0   # dB re 1 V/Pa

# è®¡ç®—é»˜è®¤çš„å…¨å°ºåº¦å¹…åº¦ï¼ˆç”¨äºæ¨å¯¼é»˜è®¤åˆ†æ•°ï¼‰
def_full_scale = (REFERENCE_PRESSURE *
                  10 ** (DEFAULT_CLIPPING / 20) *
                  10 ** (DEFAULT_SENSITIVITY / 20))
# ---------------------- å‚æ•°è§£æ ----------------------

def parse_args():
    parser = argparse.ArgumentParser(
        description="åŠ¨æ€éº¦å…‹é£å¢ç›Šè°ƒæ•´ï¼Œå…·æœ‰æ ¡å‡†ã€æµ‹è¯•æ¨¡å¼å’Œè‡ªæˆ‘ä¿®æ”¹ã€‚"
    )
    parser.add_argument("--calibrate", action="store_true", help="è¿è¡Œäº¤äº’æ ¡å‡†æ¨¡å¼")
    parser.add_argument("--test", action="store_true", help="è¿è¡Œæµ‹è¯•æ¨¡å¼ï¼Œä»¥ä½¿ç”¨ plotext æ˜¾ç¤ºå®æ—¶ RMS å›¾")
    return parser.parse_args()

# ---------------------- éŸ³é¢‘å’Œå¢ç›ŠåŠ©æ‰‹ ----------------------

def debug_print(msg, level="info"):
    current_time = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())
    print(f"[{current_time}] [{level.upper()}] {msg}")

def get_gain_db(mic_name):
    try:
        output = subprocess.check_output(['amixer', 'sget', mic_name],
                                           stderr=subprocess.STDOUT).decode()
        match = re.search(r'\[(-?\d+(\.\d+)?)dB\]', output)
        if match:
            return float(match.group(1))
        else:
            debug_print("æœªæ‰¾åˆ°å¢ç›Šä¿¡æ¯ã€‚", "warning")
    except subprocess.CalledProcessError as e:
        debug_print(f"amixer sget å¤±è´¥ï¼š{e}", "error")
    return None

def set_gain_db(mic_name, gain_db):
    gain_db = max(min(gain_db, MAX_GAIN_DB), MIN_GAIN_DB)
    try:
        subprocess.check_call(['amixer', 'sset', mic_name, f'{int(gain_db)}dB'],
                              stdout=subprocess.DEVNULL, stderr=subprocess.STDOUT)
        debug_print(f"å¢ç›Šè®¾ç½®ä¸ºï¼š{gain_db} dB", "info")
        return True
    except subprocess.CalledProcessError as e:
        debug_print(f"è®¾ç½®å¢ç›Šå¤±è´¥ï¼š{e}", "error")
    return False

def capture_audio(rtsp_url, duration=5):
    cmd = ['ffmpeg', '-loglevel', 'error', '-rtsp_transport', 'tcp',
           '-i', rtsp_url, '-vn', '-f', 's16le', '-acodec', 'pcm_s16le',
           '-ar', str(SAMPLING_RATE), '-ac', '1', '-t', str(duration), '-']
    try:
        process = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = process.communicate()
        if process.returncode != 0:
            debug_print(f"ffmpeg å¤±è´¥ï¼š{stderr.decode().strip()}", "error")
            return None
        return np.frombuffer(stdout, dtype=np.int16).astype(np.float32) / 32768.0
    except Exception as e:
        debug_print(f"éŸ³é¢‘æ•è·å¼‚å¸¸ï¼š{e}", "error")
        return None

def bandpass_filter(audio, lowcut, highcut, fs, order=4):
    sos = butter(order, [lowcut, highcut], btype='band', fs=fs, output='sos')
    return sosfilt(sos, audio)

def measure_rms(audio):
    return float(np.sqrt(np.mean(audio**2))) if len(audio) > 0 else 0.0

# ---------------------- äº¤äº’å¼æ ¡å‡† ----------------------

def prompt_float(prompt_str, default_val):
    while True:
        user_input = input(f"{prompt_str} [{default_val}]: ").strip()
        if user_input == "":
            return default_val
        try:
            return float(user_input)
        except ValueError:
            print("æ— æ•ˆè¾“å…¥ï¼›è¯·è¾“å…¥æ•°å€¼ã€‚")

def interactive_calibration():
    print("\n-- äº¤äº’å¼æ ¡å‡† --")
    print("è¾“å…¥éº¦å…‹é£ç‰¹æ€§ï¼ˆæŒ‰ Enter ä»¥æ¥å—é»˜è®¤å€¼ï¼‰ï¼š\n")
    snr = prompt_float("1) ä¿¡å™ªæ¯” (dB)", DEFAULT_SNR)
    self_noise = prompt_float("2) è‡ªå™ªå£° (dB-A)", DEFAULT_SELF_NOISE)
    clipping = prompt_float("3) å‰ªåˆ‡ SPL (dB)", DEFAULT_CLIPPING)
    sensitivity = prompt_float("4) çµæ•åº¦ (dB re 1 V/Pa)", DEFAULT_SENSITIVITY)
    return {
        "snr": snr,
        "self_noise": self_noise,
        "clipping": clipping,
        "sensitivity": sensitivity,
    }

def calibrate_and_propose(mic_params):
    user_snr = mic_params["snr"]
    # è‡ªå™ªå£°è¢«æ”¶é›†ä½†ä¸ç›´æ¥ç”¨äºè¿™äº›è®¡ç®—ã€‚
    clipping = mic_params["clipping"]
    sensitivity = mic_params["sensitivity"]

    # æ ¹æ®å‰ªåˆ‡å’Œçµæ•åº¦è®¡ç®—ç”¨æˆ·çš„å…¨å°ºåº¦å¹…åº¦ï¼š
    user_full_scale = (REFERENCE_PRESSURE *
                       10 ** (clipping / 20) *
                       10 ** (sensitivity / 20))
    
    # ä»é»˜è®¤é˜ˆå€¼æ¨å¯¼é»˜è®¤åˆ†æ•°ï¼š
    fraction_high_default = NOISE_THRESHOLD_HIGH / def_full_scale
    fraction_low_default  = NOISE_THRESHOLD_LOW  / def_full_scale

    # ä½¿ç”¨ç”¨æˆ· SNR ä¸é»˜è®¤ SNR çš„æ¯”ä¾‹è°ƒæ•´é˜ˆå€¼ï¼š
    snr_ratio = user_snr / DEFAULT_SNR

    proposed_high = fraction_high_default * user_full_scale * snr_ratio
    proposed_low  = fraction_low_default  * user_full_scale * snr_ratio

    # å¯¹äºå¢ç›ŠèŒƒå›´ï¼Œæ ¹æ®çµæ•åº¦çš„å·®å¼‚è¿›è¡Œè°ƒæ•´ï¼š
    gain_offset = (DEFAULT_SENSITIVITY - sensitivity)
    proposed_min_gain = MIN_GAIN_DB + gain_offset
    proposed_max_gain = MAX_GAIN_DB + gain_offset

    # æ˜¾ç¤ºå½“å‰å€¼å’Œå»ºè®®å€¼ï¼š
    print("\n===============================================================")
    print("å½“å‰å€¼ï¼š")
    print("---------------------------------------------------------------")
    print(f"  NOISE_THRESHOLD_HIGH: {NOISE_THRESHOLD_HIGH:.7f}")
    print(f"  NOISE_THRESHOLD_LOW:  {NOISE_THRESHOLD_LOW:.7f}")
    print(f"  MIN_GAIN_DB:          {MIN_GAIN_DB}")
    print(f"  MAX_GAIN_DB:          {MAX_GAIN_DB}")
    print("---------------------------------------------------------------\n")
    print("å»ºè®®å€¼ï¼š")
    print("---------------------------------------------------------------")
    print(f"  å»ºè®® NOISE_THRESHOLD_HIGH: {proposed_high:.7f}")
    print(f"  å»ºè®® NOISE_THRESHOLD_LOW:  {proposed_low:.7f}\n")
    print("  å»ºè®®å¢ç›ŠèŒƒå›´ (dB)ï¼š")
    print(f"    MIN_GAIN_DB: {proposed_min_gain:.2f}")
    print(f"    MAX_GAIN_DB: {proposed_max_gain:.2f}")
    print("---------------------------------------------------------------\n")

    return {
        "noise_threshold_high": proposed_high,
        "noise_threshold_low": proposed_low,
        "min_gain_db": proposed_min_gain,
        "max_gain_db": proposed_max_gain,
    }

def persist_calibration_to_script(script_path, proposal):
    subs = {
        "NOISE_THRESHOLD_HIGH": f"{proposal['noise_threshold_high']:.7f}",
        "NOISE_THRESHOLD_LOW":  f"{proposal['noise_threshold_low']:.7f}",
        "MIN_GAIN_DB":          f"{int(round(proposal['min_gain_db']))}",
        "MAX_GAIN_DB":          f"{int(round(proposal['max_gain_db']))}"
    }
    for var, val in subs.items():
        cmd = f"sed -i 's|^{var} = .*|{var} = {val}|' \"{script_path}\""
        os.system(cmd)
    print("âœ… è„šæœ¬å·²ä½¿ç”¨æ–°æ ¡å‡†å€¼æ›´æ–°ã€‚\n")

# ---------------------- æµ‹è¯•æ¨¡å¼ï¼šä½¿ç”¨ plotext å®æ—¶ RMS å›¾ ----------------------

def test_mode():
    try:
        import plotext as plt
    except ImportError:
        print("plotext æ˜¯æµ‹è¯•æ¨¡å¼æ‰€éœ€çš„ã€‚è¯·ä½¿ç”¨ï¼špip install plotext å®‰è£…å®ƒ")
        sys.exit(1)

    print("\n-- æµ‹è¯•æ¨¡å¼ï¼šå®æ—¶ RMS çº¿å›¾ï¼ˆplotextï¼‰--")
    print("å¾ªç¯å½•åˆ¶ 5 ç§’æ ·æœ¬ã€‚æŒ‰ Ctrl+C é€€å‡ºã€‚\n")

    rms_history = []
    iterations = []
    max_points = 20  # çª—å£ä¸­æ˜¾ç¤ºçš„æ ·æœ¬æ•°
    i = 0

    while True:
        audio = capture_audio(RTSP_URL, duration=5)
        if audio is None or len(audio) == 0:
            print("æœªæ•è·åˆ°éŸ³é¢‘ï¼Œé‡è¯•...")
            time.sleep(5)
            continue

        filtered_audio = bandpass_filter(audio, LOWCUT, HIGHCUT, SAMPLING_RATE, FILTER_ORDER)
        rms = measure_rms(filtered_audio)

        rms_history.append(rms)
        iterations.append(i)
        i += 1

        # ä»…ä¿ç•™æœ€å `max_points` æ¡ç›®
        if len(rms_history) > max_points:
            rms_history = rms_history[-max_points:]
            iterations = iterations[-max_points:]

        # ç¡®å®šæ–‡æœ¬è¾“å‡ºçš„çŠ¶æ€
        if rms > NOISE_THRESHOLD_HIGH:
            status = "ğŸ”´ è¶…è¿‡"
        elif rms < NOISE_THRESHOLD_LOW:
            status = "ğŸ”µ ä½äº"
        else:
            status = "ğŸŸ¢ æ­£å¸¸"

        # ç»˜åˆ¶å›¾å½¢
        plt.clf()
        plt.plot(iterations, rms_history, marker="dot", color="cyan")
        plt.horizontal_line(NOISE_THRESHOLD_HIGH, color="red")
        plt.horizontal_line(NOISE_THRESHOLD_LOW, color="blue")
        plt.title("å®æ—¶ RMSï¼ˆçº¿å›¾ï¼‰")
        plt.xlabel("è¿­ä»£")
        plt.ylabel("RMS")
        plt.ylim(0, max(0.001, max(rms_history) * 1.2))
        plt.show()

        print(f"å½“å‰ RMS: {rms:.6f} â€” {status}")
        time.sleep(0.5)

# ---------------------- åŠ¨æ€å¢ç›Šæ§åˆ¶å¾ªç¯ ----------------------

def dynamic_gain_control():
    debug_print("å¯åŠ¨åŠ¨æ€å¢ç›Šæ§åˆ¶å™¨...")
    set_gain_db(MICROPHONE_NAME, (MIN_GAIN_DB + MAX_GAIN_DB) // 2)
    while True:
        audio = capture_audio(RTSP_URL)
        if audio is None or len(audio) == 0:
            debug_print("æœªæ•è·åˆ°éŸ³é¢‘ï¼›é‡è¯•...", "warning")
            time.sleep(SLEEP_SECONDS)
            continue
        filtered_audio = bandpass_filter(audio, LOWCUT, HIGHCUT, SAMPLING_RATE, FILTER_ORDER)
        rms = measure_rms(filtered_audio)
        debug_print(f"æµ‹å¾— RMS: {rms:.6f}", "info")
        current_gain = get_gain_db(MICROPHONE_NAME)
        if current_gain is None:
            debug_print("è¯»å–å½“å‰å¢ç›Šå¤±è´¥ï¼›è·³è¿‡å¾ªç¯ã€‚", "warning")
            time.sleep(SLEEP_SECONDS)
            continue
        if rms > NOISE_THRESHOLD_HIGH:
            debug_print(f"ä¿¡å·è¿‡é«˜ï¼š{rms:.6f} > {NOISE_THRESHOLD_HIGH:.7f}ã€‚æ­£åœ¨é™ä½å¢ç›Š...", "info")
            set_gain_db(MICROPHONE_NAME, current_gain - GAIN_STEP_DB)
        elif rms < NOISE_THRESHOLD_LOW:
            debug_print(f"ä¿¡å·è¿‡ä½ï¼š{rms:.6f} < {NOISE_THRESHOLD_LOW:.7f}ã€‚æ­£åœ¨å¢åŠ å¢ç›Š...", "info")
            set_gain_db(MICROPHONE_NAME, current_gain + GAIN_STEP_DB)
        else:
            debug_print("RMS åœ¨å¯æ¥å—èŒƒå›´å†…ï¼›æ²¡æœ‰å¢ç›Šå˜åŒ–ã€‚", "info")
        time.sleep(SLEEP_SECONDS)

# ---------------------- ä¸» ----------------------

def main():
    args = parse_args()

    if args.calibrate:
        mic_params = interactive_calibration()
        proposal = calibrate_and_propose(mic_params)
        save = input("æ˜¯å¦å°†è¿™äº›å€¼æ°¸ä¹…ä¿å­˜åˆ°è„šæœ¬ä¸­ï¼Ÿ[y/N]: ").strip().lower()
        if save in ["y", "yes"]:
            script_path = os.path.abspath(__file__)
            persist_calibration_to_script(script_path, proposal)
            print("ğŸ‘ æ ¡å‡†å€¼å·²ä¿å­˜ã€‚ç°åœ¨é€€å‡ºã€‚\n")
        else:
            print("âŒ ä¸ä¿å­˜å€¼ã€‚é€€å‡ºã€‚\n")
        sys.exit(0)

    if args.test:
        test_mode()
        sys.exit(0)

    # æ­£å¸¸æ“ä½œï¼šè¿è¡ŒåŠ¨æ€å¢ç›Šæ§åˆ¶ã€‚
    dynamic_gain_control()

if __name__ == "__main__":
    main()